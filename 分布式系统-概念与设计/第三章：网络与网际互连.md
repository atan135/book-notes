分布式系统使用局域网、广域网和互连网络进行通信。底层网络的性能、可靠性、可伸缩性、移动性以及服务质量的特征都会影响到分布式系统的行为。

## 网络原理

数据包使用长度有限的原因：

* 网络中的每台计算机需要为可能到来的数据包分配足够的内存缓冲空间
* 避免长消息不加分个的传递引来的为等待通信信道空闲而出现的过度延迟现象

### 路由算法

```
Send: 每隔t秒活在Tl发生变化时，在每个没有故障的链路上发送Tl
Receive：当在链路n上接收到路由表Tr时：
for all rows Rr in Tr:
    if Rr.link != n:
        Rr.cost = Rr.cost + 1;
        Rr.link = n;
        if Rr.destination不在Tl中，将Rr加入到Tl
        else:
            if Rr.destination = Rl.destination AND 
                Rr.cost < Rl.cost OR Rl.link = n:
                    Rl = Rl
                    //Rr.cost < Rl.cost说明远程节点有更好的路由
                    //Rl.link = n说明远程节点更加权威
```

### ip伪冒漏洞

分布式拒绝服务攻击的一种方法是在几个站点向大量的计算机发出ping请求，这些恶意的ping请求在发送方地址域中填写的是目标计算机的ip地址，因此ping的应答就指向了目标计算机，造成他们的输入缓冲溢出，造成喝发的ip数据包无法通过。

### TCP可靠性传输的几个机制
##### 排序
TCP发送进程将数据流分割成数据片段序列，然后作为ip数据包的数据部分传送。每个TCP片段均有一个序号，在接收端使用序号进行排序，未按顺序到达的片段必须保存在一个缓冲区中，直到前面的片段到达为止。
##### 流控制
发送方管理不能使接收方或者中间节点过载，这通过片段确认机制完成。当接收方成功的接受了一个片段后，他会记录该片段的序号，接收方会不时地像发送方发送确认信息，给出输入流中片段的最大序号以及窗口大小。这就控制了允许发送方传送的数据量。
##### 重传机制
发送方记录它发送的片段的序号，当收到一个确认消息时，将该序号的数据从发送缓冲区中删除。如果在一个指定时间内没有收到确认，则这个序号的消息重新发送。
##### 缓冲
接收方的接收缓冲区用于平衡发送方和接收方之间的流量。如果接受进程发出receive操作的速度比发送方send操作的速度慢得多，那么缓冲区数量会增加，如果最终溢出，则数据不会被记录而丢弃，直至发送方再重传。
##### 校验和
每个片段包含一个对头部和片段中数据的校验和，如果接收到的片段的校验和不匹配，则丢弃。

### 防火墙
防火墙的目的是监视和控制进出企业内部网的所有通信。使用一组进程实现，作为通向企业内部网的网关，应用预先规定的安全策略。
##### 服务控制
用于确定内部主机中哪些服务可以接受外部访问，而拒绝其他的服务请求。这些过滤行为可以基于ip数据包的内容以级其中包含的TCP和UDP请求来完成。
##### 行为控制
用于防止破坏公司策略的行为。其中一些过滤行为可以通过IP或者TCP层进行，但是有些需要更高层对消息进行解析处理。如邮件过滤系统
##### 用户控制
对用户之间访问权限进行区分。

防火墙的过滤操作有三种：

* IP数据包过滤
* TCP网关
* 应用层网关

Q & A
=======================================
###### 1. 一个客户将200字节的请求发送到一个服务，服务产生了5000的回复字节，估算下列情况的请求完成时间。

1. 使用无连接通信
2. 使用面向连接的通信
3. 服务器进程与客户进程在同一台计算机上

###### 其中发送或者接受延迟t1=5ms，建立连接时间t2=5ms，数据传输速率是10Mbps，MTU=1000字节，服务器请求处理时间是t3=2ms，假设网络处于轻负载状态

1. 在使用无连接通信UDP时，总时间为t1+200 / 10000 + t3 + 5000 / 10000
2. 使用TCP通信，总时间为t2 + t1 + 200 / 10000 + t3 + 5000 / 10000
3. 在同一服务器上，时间为减去网络传输时间

###### 2. 互联网非常大，任何路由器均无法完成记录所有目的地的路由信息，那么互联网路由器是怎样处理这个问题的
在小网络中使用了简单的路由器信息协议RIP算法，邻近路由器相互交换网络信息，完成整体路由表的生成。其中RIP-1基于距离-向量算法，RIP-2还包含了其他需求，包括无类别域间路由、更好的组播路由以级认证RIP数据包以避免路由器收到攻击。随着互联网规模的扩大，RIP的距离-向量算法存在收敛速度慢，潜在的不稳定性，现在趋向于使用链路-状态算法 **开放最短路径优先算法OSPF** 基于 _Dijkstra_ 的路径寻找算法，比RIP有更快的收敛速度。此外，使用了默认路由的机制和IP地址拓扑分组技术。

###### 3. 以太网交换机的任务是什么，他要维护那些表？
以太网交换机的作用是将多个分离的以太网互联，将到达的数据包路由到适当的外出网络中。组要维护一个网络地址-硬件地址的映射表。

###### 4. 构造一个类似下图的表，描述当互联网应用与TCP/IP协议组在以太网上实现时，每个协议层中的软件所作的工作。

| 层         | 描述                                                     | 例子                           |
| ---------- | -------------------------------------------------------- | ------------------------------ |
| 应用层     | 为了满足特定应用的通信需求涉及的，通常定义了一个服务接口 | HTTP、FTP、SMTP                |
| 表示层     | 以一种网络表示传输数据，如果需要可以加密                 | TLS安全、CORBA数据表示         |
| 会话层     | 在这层实现可靠性和适应性，如故障检测和自动回复           | SIP                            |
| 传输层     | 处理消息的最底一层，消息被定位到与进程相关的通信端口上   | TCP、UDP                       |
| 网络层     | 在特定的网络中的计算机之间传输数据包                     | IP、ATM虚电路                  |
| 数据链路层 | 负责在有直接物理连接的节点间传输数据包                   | Ethernet MAC、ATM心愿传送、PPP |
| 物理层     | 驱动网络的电路和硬件，通过传输二进制数据序列             | Ethernet基带信号、ISDN         |

选取应用层、（表示层）、传输层、网络层、数据链路层的相关信息，即可。

###### 5. 端到端争论是如何用于互联网的设计的，考虑使用虚电路网协议代替IP会如何影响万维网的可行性。
主要是在网络TCP层可靠性传输，是靠两端点的检测、排序、重传等机制完成，而不需要依赖与通信信道的可靠与否。使用虚电路协议的网络服务，需要先在源主机和目的主机简历虚电路，每个中间节点都会有相应记录。如果万维网使用了虚电路协议，所有的HTTP请求都会先建立信号通道再传输数据，而且中间不可更改，和IP层的无连接属性相比，通信成本会大大增加，而且对于一个节点出错，只能通过重新建立整个连接处理。

###### 6. 我们能确保互联网中不会有两台计算机使用同一个IP地址么？
不能保证，
1. 局域网可以使用的三个IP段`10.0.0.0~10.255.255.255`,`172.16.0.0~172.31.255.255`,`192.168.0.0~192.168.255.255`，这三个内网IP段是可以在互联网每个局域网中重复使用的。
2. NAT网络地址翻译的机制，可以使得多个计算机使用同一个外网IP
3. 连接在互联网上的计算机，可以篡改自己发送的IP报的源地址

###### 7. 对于下面应用层和表示层的协议的实现，比较无连接UDP和面向连接TCP通信。
* 虚拟终端访问----------------- *使用TCP保证通信可靠传输*
* 文件传输--------------------- *使用TCP保证文件的可靠传输*
* 用户位置（rwho,用于查询所在局域网的所有用户）----- *使用UDP*
* 信息浏览------------------------- *使用TCP保证可靠传输*
* 远程过程调用-------------------- *使用TCP保证可靠传输*

###### 8. 解释在广域网络中，为什么会发生数据包序列到达目的地顺序与发出顺序不一致的原因，为什么在局域网中不可能出现。
广域网中，数据包在IP上传输，IP是无连接的，每个数据包的传输路径不能保证一致性，最终到达目的地的时间也就可能有先来后到的。局域网中的数据包是连续的数据流，所以不存在顺序不一致的。

###### 9. 在Telnet这样的远程终端访问协议中，需要解决一个问题，即Kill信号这样的异常事件需要在前面传输的数据之前到达主机，Kill信号应该在任何其他正在进行的传输之前到达目的地。讨论该问题在无连接和面向连接协议下的解决方案。
在tcp数据包中有个字段PSH，这个字段设置后，接收端接收到该数据包，不需要等待缓冲区满，而直接发送给上层应用层。UDP是无连接的数据传输协议，没有办法做到Kill信号在其他信号之前到达主机，这个先后顺序完全由IP层传输的时间决定。

###### 10. 使用网络层广播在以下网络中定位资源有哪些缺点？
1. 在单个以太网中 ----------------- 没看出来有什么缺点
2. 在企业内部网中------------------ 形成广播风暴？不确定

以太网组播在何种程度上改善了广播？----减少了局域网内所有计算机接受数据包次数吧

###### 11. 提出一个改善移动IP的方案，以便一个移动设备可以访问web服务器，该移动设备有时通过移动电话连接到互联网上，而在其他时候通过有线网连接在互联网上。
不会，移动IP使用的是一种对用户透明的用户移动访问互联网的机制。主要机制是移动主机在不同位置的子网移动时，在更上一层主域空间中，移动设备是有一个永久固定的IP的，移动设备接入子网的时候，由两个代理进程负责重新路由，一个是主代理，用于保存移动设备的当前位置的最新情况，一个是外地代理，用于在接入后分配一个本地子网的新的临时IP用于通信，HA作为代理负责转接。

###### 12. 说明在图中路由链路断开后，相关路由表的顺序。
首先是链路两端的路由器经对应路由器端口到对应路由器的开销标注为断开，然后临近路由器通过RIP协议收到也是断开的后更新自己路由表，但是最终可以通过另一条链路取得路由表的联系。

###### 13. 描述到服务器的一个HTTP请求的分割与封装过程以级相应的应答。假设请求是一个短的HTTP消息，而应答包括至少2000字节到达HTML。
客户端将请求消息封装成一个HTTP请求，然后在TCP层添加TCP头部封装成TCP数据包，在IP层添加IP头部封装成IP数据报，直接通过网络IP经过多个路由传输抵达服务器主机，服务端将接收到的IP数据包拆解校验CRS，传递到TCP层重排，校验数据正确性后拆解，将HTTP消息返回给对应服务器进程。这里因为返回是至少2000字节的请求，因此会在IP数据报的生成过程中进行分包，在接收端需要重新IP数据报排序接收。

###### 14. 考虑在Telnet远程终端客户中使用TCP，应该如何在客户端缓冲键盘输入？
1. 一个web服务器
2. 一个Telnet应用
3. 一个具有鼠标输入的远程图形应用
  ------------------不懂

###### 使用TCP时，对比简单处理方式，研究Nagle和Clark的流控制算法，比较这两个算法。
正常的TCP通信，消息的发送需要满足其中一个条件：1. 数据片段在缓冲区以级停留了T秒；2. 数据缓冲区信息已满。Nagle算法可以减少传输过程数据流的传输，因为它会将小包数据积累在缓存中，知道满足T时长后才会发送数据，这种算法适合一般的网络传输，但是不适合在交互式的互联网应用中使用。

###### 15. 构造你工作单位的局域网的网络图。
工作单位为某游戏工作室，内部局域网为使用路由器与外界连接的以太局域网，局域网内部置有文件服务器、web服务器，计算机通过多个集线器连接在整个局域网中，出网存在由防火墙，屏蔽了p2p网络文件传输和大文件ftp传输。内部局域网通过使用VPN从广州连接了北京的内部局域网。

###### 16. 描述如何配置防火墙，以保护你的工作单位的局域网，应该拦截哪些进出的请求。
防火墙安全策略包括服务控制、行为控制和用户控制，手段是ip数据包过滤，tcp网关和应用层网关三种。我司防火墙主要作用的是服务控制，通过应用层网关，屏蔽了外网的ftp文件传输和p2p文件传输。

###### 17. 一个连接到以太网的新安装的个人计算机是如何发现本地服务器的ip地址的，他是如何将ip地址翻译成以太网地址的。
每个主机的ARP模块维护了一个地址映射缓存表，保存由它之前获得的局域网中各主机的ip地址-以太网地址对，如果需要的ip地址位于这个缓存中，则直接提供对应的以太网地址，如果没有，则ARP模块会在本地的以太网发出一个以太网广播数据包（ARP请求数据包），数据中包含了所需的ip地址，本地以太网每个计算机都受到了这个ARP请求数据包，并将自己的ip地址和数据包的ip地址匹配，如果符合，则发送一个ARP应答，如果不匹配，则忽略。收到ARP应答后，从报文中提取该ip地址-以太网地址，存入自己缓存中。

###### 18. 防火墙是否可以防止分布式服务拒绝攻击？可以使用哪些其他方法处理这样的攻击？
可以，对ping请求包通过防火墙拒绝掉。此外的解决方法还有：
* 服务器关闭不必要的服务
* 限制服务器打开的syn半连接数量
* 缩短服务器Syn半连接的Timeout时间
* 防火墙禁止对服务器的非服务端口访问
* 路由器设置Syn数据包流量速度