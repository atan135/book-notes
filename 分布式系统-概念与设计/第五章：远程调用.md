**远程过程调用**

RPC将过程调用的通用编程抽象扩展到分布式环境。一个调用过程可以像调用本地节点上的过程那样去调用一个远程节点的过程。

**远程方法调用**

RMI在分布式系统中使用了面向对象的编程概念，把对象引用扩展到全局分布式环境中，因此在远程调用中可以吧对象引用作为参数。

## 请求应答协议
使用三个通信原语`doOperation`,`getRequest`,`sendReply`完成。

<dl>
<dt>客户端使用doOperation方法调用远程操作</dt>
<dd>方法参数指定远程服务器、带调用的操作以级操作请求的附加信息（参数）。
</dl>
<dl>
<dt>服务端通过getRequest方法获得请求消息</dt>
<dt>服务端通过sendReply方法向客户发送应答消息</dt>
</dl>

#### 请求应答协议的故障模型：

**1. 超时**

超时发生时，doOperation的简单选择是立即返回给客户一个doOperation操作故障的标识。但是这个不是常见的方法。超时的原因又请求或应答消息丢失。对于后者，该操作已经被执行，为了避免消息丢失的可能，doOperation方法会重复的发送请求消息直到它收到应答，或已有理由相信延迟是因为服务器未作应答而不是丢失了请求消息。最终，doOperation方法返回时，会以为接收到结果的异常通知调用客户。

**2. 丢弃重复的请求消息**

当请求消息重复传输时，服务器可能不止一次的接收到该消息，协议设计能识别出带有相同请求标识符的连续信息，过滤掉重发信息。

**3. 丢失应答消息**

当服务器收到一个重复的请求消息时已经发送了应答消息，那么除非它保存了原先执行的结果，否则它需要再次执行这个操作来获得该结果。  **概念：幂等操作**

**4. 历史**

对于要求重新传输应答而不需要重新执行操作的服务器来说，可以使用历史，这指包含已发送的应答消息的记录的结构。

**三种RPC交换协议**

| 名字 | 客户 | 服务器 | 客户     |
| ---- | ---- | ------ | -------- |
| R    | 请求 |        |          |
| RR   | 请求 | 应答   |          |
| RRA  | 请求 | 应答   | 确认应答 |

## HTTP协议使用
**内容协商：** 客户端请求中包含说明他们能够接收的数据表示形式的信息，使服务器能选择出对于客户端最合适的数据表示形式。

**认证：** 试图去访问受保护的资源时，服务器的应答包含了适用于咨询的质询(challenge)，当客户端收到质询，它令用户输入用户名和密码，并提交与后续请求相关联的凭据(credential).

HTTP基于TCP协议，在该协议的最初版本中，由以下步骤组成：

* 客户端请求连接，服务器在一个默认端口或者URL指定端口下接收连接。
* 客户端向服务器发送请求消息。
* 服务端向客户端发送应答。
* 连接断开

在HTTP1.1中，对相同服务器连续多个请求，使用 **持久连接** 减少连接建立、断开的损失。

#### HTTP方法

**GET方法：** 请求在参数中给出的URL对应的资源，如果URL对应数据，那么服务器就会返回URL指定的数据，如果URL对应程序，那么服务器就会运行该程序并把结果返回给客户端。

**HEAD方法：** 请求与GET相同，但是它不反悔任何数据，然而返回与数据相关的所有信息，如最后一次修改时间，数据的格式，大小。

**POST方法：** 指定资源的URL，该资源可以处理在请求消息体中提供的数据。当某个执行活动可能改变服务器数据时，使用POST方法。

**PUT方法：** 要求请求中提供的数据在存储时以指定的URL作为标识符，要么作为现有资源的修改，要么作为一种新资源。

**DELETE方法：** 服务器删除给定URL标识的资源，服务器可能不经常允许该操作，这种情况下返回失败的应答。

**OPTIONS：** 服务器提供给客户端能够应用到给定URL及其特定需求的方法列表。

**TRACE：** 服务器返回请求的消息，用于诊断的目的。

**HTTP请求消息组成**

| 方法 | URL或路径名                     | HTTP版本 | 头部 | 消息体 |
| ---- | ------------------------------- | -------- | ---- | ------ |
| GET  | http://www.baidu.com/index.html | HTTP/1.1 |      |        |


**HTTP应答消息组成**
| HTTP版本 | 状态码 | 理由 | 头部 | 消息体   |
| -------- | ------ | ---- | ---- | -------- |
| HTTP/1.1 | 200    | OK   |      | 资源数据 |

其中消息体自身的头部信息标识了数据信息，如消息体的长度，MIME类型，字符集，内容编码和最后的修改时间。

## 远程过程调用
**接口编程** 大多数现代编程语言提供了把一个程序组织成一系列能彼此通信的模块的方法。模块之间的通信可以依靠模块间的过程调用，或者直接访问另外一个模块中的变量来实现。为了控制模块之间可能的交互，需要为每一个模块定义显式的接口，模块接口指定可供其他模块访问的过程和变量。实现后模块就隐藏了除接口以外的所有信息。只要模块的接口保持相同，模块的实现就可以随意改变而不影响模块的使用者。

**RPC调用语义**

* **或许调用语义：** 远程方法可能执行，也可能不执行。当没有使用任何容错措施的时候，就启用了或许调用语义。可能会出现的故障有
  * 遗漏故障：如果调用或结果消息丢失
  * 系统崩溃：由于包含远程对象的服务器出现故障
* **至少一次调用语义：** 调用者可能收到返回结果，也可能收到一个异常。在收到返回结果的情况下，调用者知道方法至少执行了一次，而异常信息则通知它没有接收到执行结果。可以通过重发请求消息来实现，屏蔽了调用或者消息的遗漏故障。可能出现的故障有：
  * 由于包含远程对象的服务器故障而系统奔溃
  * 随即故障：重发消息时，远程对象可能接收到这一消息并多次执行调用方法，导致存储或者返回了异常值
* **至多一次调用语义：** 调用者可以接收返回结果，也可以接收一个异常。在接受返回结果时，调用者知道恰好执行了一次，而异常信息则通知调用者没有收到执行结果。

**容错措施**

| 重发请求消息 | 过滤重复消息 | 重新执行过程或重传应答 | 调用语义 |
| ------------ | ------------ | ---------------------- | -------- |
| 否           | 不适用       | 不适用                 | 或许     |
| 是           | 否           | 重新执行过程           | 至少一次 |
| 是           | 是           | 重传应答               | 至多一次 |

**样例：SUN RPC**

SUN RPC可以使用基于UDP协议实现，也可以使用基于TCP使用，采用UDP协议时，请求消息和应答消息的长度被限制在一定长度范围内。SUN RPC使用至少调用一次语义。

SUN RPC使用一种称为XDR的接口语言和一个可以用于C编程语言的接口编译器rpcgen

SUN RPC实现细节；

1. 提供一个程序号和一个版本号，用于保证每个程序都有唯一编号。
2. 一个过程定义指定一个过程签名和一个过程号。过程号作为请求消息中的过程标识符。
3. 只允许使用单个输入参数，因此多个参数需要使用结构作为参数的集合。
4. 过程的输出参数是单个结果
5. 过程签名由返回类型，过程名和输入参数类型组成，返回结果和输入参数的类型可以指定为单个的值，也可以指定为包含几个的值的结构。
6. 当一个过程签名改变时，版本号也会随着改变，程序号和版本号都会在消息中传输，以便客户和服务器验证他们是否正在使用相同的版本。

一个典型的SUN RPC接口文件：
    
    const MAX = 1000;
    typedef int FileIdentifier;
    typedef int FilePointer;
    typedef int Length;
    struct Data{
        int length;
        char buffer[MAX];
    };
    struct writeargs{
        FileIdentifier f;
        FilePointer position;
        Data data;
    };
    struct readargs{
        FileIdentifier f;
        FilePointer position;
        Length length;
    };
    
    program FILEREADWRITE{
        version VERSION{
            void WRETE(writeargs)=1;
            DATA READ(readargs)=2;
        }=2;
    }=9999;

接口文件使用rpcgen生成以下部分：

* 客户存根过程
* 服务器main过程，分发器和服务器存根过程
* 用于分发器，客户与服务器存根过程的XDR编码与解码过程

**绑定**

SUN RPC使用一个称为端口映射器的本地绑定工具。里面记录了本地运行的所有服务所使用的程序号、版本号、端口号。当服务器启动时，在端口映射器注册其服务的程序号、版本号和端口号。当客户启动时，发送指定程序的程序号、版本号的远程请求到服务器主机上的端口映射器，从而找到服务的端口。

**认证**

SUN RPC请求和应答消息提供了一些附加域，用于客户与服务器之间的传输认证消息。

## 远程方法调用RMI
**RMI和RPC的共性：**

* 都支持接口编程，同时能带来使用这种方法的好处
* 都是典型的基于请求-应答协议构造的，能提供一些列的调用语义
* 都提供相似程度的透明性。

**RMI在副本是应用中的额外功能：**

* 程序员能够在分布式系统软件开发中使用所有的面向对象编程的功能，包括对象、类、继承的使用以级相关面向对象的设计方法和相关工具的使用。
* 对象引用可以作为参数传递，因此RMI比RPC能提供更多的参数传递语义。
