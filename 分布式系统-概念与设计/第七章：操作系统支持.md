本章的目标是讨论某种操作系统机制对中间件提供分布式资源能力的影响。内核与运行在其上的客户和服务器进程是我们所关心的主要的体系结构组件。内核和服务器进程作用域管理资源和为客户提供资源接口，因此，它们需要具备以下特点：

* **封装：** 它们应该提供有用的能够访问资源的服务接口。
* **保护：** 资源需要被保护以放置非法访问。
* **并发处理：** 客户可以共享资源并能并发的访问它们，资源管理器负责实现并发透明性。

**核心操作系统组件和它们的责任是：**

* **进程管理器：** 负责进程的创建，进程包括一个地址空间和一个或多个线程，是资源管理单元。
* **线程管理器：** 负责线程创建、同步和调度。线程是与进程相关的调度活动。
* **通信管理器：** 负责同一台机器上不同进程中线程之间的通信。一些内核也支持远程进程的线程之间通信。
* **内存管理器：** 负责管理物理内存和虚拟内存。
* **底层管理器：** 负责处理中断、系统调用陷阱和其他异常，同时控制内存管理单元和硬件缓存以及处理器和浮点寄存器操作，在windows中，这被称为硬件抽象层。

### 内存对进程访问权限控制的细节

1. 内核在系统初始化适合就一直保持着运行并且对其主机的物理资源有完全的访问权限。特别是，它可以控制内存管理单元并设置处理器的寄存器，这就使得没有其他代码能够访问机器的物理资源，除了以内核允许的方式。
2. 大多数处理器有硬件模式的寄存器，它们的设置决定了特权指令能否被执行，例如有些指令决定内存管理单元当前采用哪一个保护表。内核进程在处理器的管理（特权）模式下执行，而内核安排其他进程在用户（非特权）模式下进行。
3. 内核通过建立地址空间来保护自己和其他进程以放置异常进程的访问，同时也为正常进程提供它们所需要的虚拟内存。一个地址空间是若干虚拟空间的集合，其中每一个区域都被赋予特定的访问权限。进程不能访问自己地址空间以外的内存空间。*用户进程* 表示在用户模式下执行并拥有用户级地址空间的进程。
4. 当一个进程执行用户程序代码时，在用户及地址空间中执行，而当这一进程执行内核代码时，它在内核地址空间执行，通过中断和系统调用陷阱，进程可以安全的从用户级地址空间转换到内核地址空间中。系统调用陷阱是一个机器级指令TRAP实现，将处理器转换为管理模式，并将地址空间切换到内核地址空间。
5. 内核的保护机制使程序执行会产生额外的开销。在地址空间之间切换会占用处理器的许多处理周期，系统调用现金也要比简单的过程调用要耗费更多的处理器资源。

**共享内存区域的应用：**

* **库：** 库的代码可以很大，如果每一个进程都独立的加载这个库，那么会占用相当大的内容。相反，可以将库代码的一个拷贝映射到需要它的多个进程的共享内存区，达到共享的目的。
* **内核：** 内核带啊吗和数据经常会被映射到每一个地址空间的相同位置，这样，当进程进行系统调用或者出现异常时，系统不需要切换到新的地址映射集合。
* **数据共享与通信：** 两个进程之间或进程与内核之间需要共享数据以达到协同工作的目的。将共享数据映射到相应的两个地址空间中的特定区域比将共享数据放在消息中传递的效率更高。

**写时拷贝：** 从父进程拷贝一个继承的区域时，默认情况，区域被拷贝，但是没有进行物理拷贝，组成继承区域的页面帧被两个地址空间共享，只有当其中一个进程试图修改区域内的页面内容时，系统才会进行物理上的拷贝。

## 线程

**多线程服务器的体系结构：**

* **一请求一线程体系结构：** IO线程为每一个请求派生一个新的工作线程，当工作线程处理完指定远程对象的请求时，会销毁自己。这种体系结构的优点是线程不会竞争共享队列，吞吐量被提高到最大限度。缺点是创建和销毁线程的巨大开销。
* **一连接一线程体系结构：** 为每个连接分配一个线程，服务器在客户建立连接时候创建一个新的工作线程，并在客户关闭连接时销毁该工作线程。
* **一对象一线程体系结构：** 将每个远程对象分别与一个线程相连，一个IO线程接受请求并将其放入队列等待工作线程处理。

**线程与进程的比较：**

* 在一个已有进程创建一个线程比创建一个进程开销小。
* 在进程的不同线程之间切换比在不同进程的线程之间切换的开销小。
* 与多进程相比，一个进程内的线程可以方便有效的共享数据和其他资源。
* 线程不能放置同一进程内其他线程的非法访问。

